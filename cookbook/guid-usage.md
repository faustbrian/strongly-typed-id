# GUID Usage

GUID (Globally Unique Identifier) is Microsoft's implementation of UUID, formatted in uppercase for compatibility with Windows and .NET ecosystems. This guide covers using GUIDs with strongly-typed IDs.

## What is GUID?

GUID is functionally identical to UUID version 4 but follows Microsoft's naming and formatting conventions:

- **Uppercase formatting**: Uses uppercase hexadecimal characters (A-F, 0-9)
- **Same structure as UUID**: 128-bit identifier with standard format
- **Microsoft compatibility**: Matches .NET's `System.Guid` output
- **RFC 4122 compliant**: Follows UUID v4 specification
- **Cryptographically random**: 122 bits of randomness ensures uniqueness

Example GUID: `550E8400-E29B-41D4-A716-446655440000`

## GUID vs UUID

The only difference is formatting:

| Aspect | GUID | UUID |
|--------|------|------|
| Format | `550E8400-E29B-41D4-A716-446655440000` | `550e8400-e29b-41d4-a716-446655440000` |
| Case | Uppercase | Lowercase |
| Ecosystem | Microsoft/.NET/Windows | Unix/Web/General |
| Standard | Same (RFC 4122) | Same (RFC 4122) |
| Randomness | Same (122 bits) | Same (122 bits) |

## Configuring GUID Generator

Enable GUID generation in your application:

```php
use Cline\StronglyTypedId\Enums\GeneratorType;
use Cline\StronglyTypedId\Facades\IdGenerator;

// In your service provider or bootstrap
IdGenerator::setGenerator(GeneratorType::Guid);
```

Now all ID generation will use GUIDs:

```php
$userId = UserId::generate();
// e.g., "550E8400-E29B-41D4-A716-446655440000"
```

## Creating IDs from GUID Strings

GUIDs are compatible with the standard `fromString()` method:

```php
$userId = UserId::fromString('550E8400-E29B-41D4-A716-446655440000');
```

Validation ensures the string is a valid GUID format:

```php
try {
    $userId = UserId::fromString('invalid-guid-format');
} catch (InvalidArgumentException $e) {
    // Handle invalid GUID
}
```

## GUID Format Structure

```
550E8400-E29B-41D4-A716-446655440000
|------||--||--||--||----------|
   8     4   4   4      12
time_low | | | |  time_node
  time_mid | |  clock_seq_hi
    time_hi | clock_seq_low
       version
```

**Format Specification** (36 characters):
- 8 hexadecimal digits (time_low)
- Hyphen
- 4 hexadecimal digits (time_mid)
- Hyphen
- 4 hexadecimal digits (time_hi_and_version)
- Hyphen
- 4 hexadecimal digits (clock_seq)
- Hyphen
- 12 hexadecimal digits (node)

**All characters are uppercase** following Microsoft conventions.

## Case Sensitivity Considerations

### Windows/Microsoft Environments

GUIDs are typically case-insensitive in Microsoft ecosystems:

```php
// Both representations are equivalent in .NET
$guid1 = '550E8400-E29B-41D4-A716-446655440000';
$guid2 = '550e8400-e29b-41d4-a716-446655440000';

// C# comparison
// Guid.Parse(guid1) == Guid.Parse(guid2) // true
```

### PHP/Laravel Considerations

PHP strings are case-sensitive by default:

```php
$guid1 = UserId::fromString('550E8400-E29B-41D4-A716-446655440000');
$guid2 = UserId::fromString('550e8400-e29b-41d4-a716-446655440000');

// These are different string values
$guid1->toString() === $guid2->toString(); // false

// But represent the same identifier semantically
```

For case-insensitive comparisons:

```php
use function mb_strtoupper;

$guid1 = UserId::fromString('550E8400-E29B-41D4-A716-446655440000');
$guid2 = UserId::fromString('550e8400-e29b-41d4-a716-446655440000');

// Normalize to uppercase for comparison
mb_strtoupper($guid1->toString()) === mb_strtoupper($guid2->toString()); // true
```

## Interoperability with Microsoft Systems

### .NET Integration

GUIDs generated by this library are compatible with .NET's `System.Guid`:

```csharp
// C# code
using System;

// Parse GUID from PHP
var guid = Guid.Parse("550E8400-E29B-41D4-A716-446655440000");

// Generate new GUID
var newGuid = Guid.NewGuid();
// Pass to PHP: newGuid.ToString().ToUpper()
```

### SQL Server

Store GUIDs in SQL Server's native `uniqueidentifier` type:

```sql
-- SQL Server table
CREATE TABLE users (
    id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    name NVARCHAR(255)
);

-- Insert from PHP
INSERT INTO users (id, name)
VALUES ('550E8400-E29B-41D4-A716-446655440000', 'John Doe');
```

In Laravel migrations with SQL Server:

```php
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

Schema::create('users', function (Blueprint $table) {
    $table->uuid('id')->primary();
    // SQL Server will use uniqueidentifier type
});
```

### Web Services

When interfacing with Microsoft web services, use GUID format:

```php
use Illuminate\Support\Facades\Http;

$userId = UserId::generate();

// Send to Microsoft API
$response = Http::post('https://api.microsoft.com/endpoint', [
    'userId' => $userId->toString(), // Uppercase GUID
]);
```

## Database Storage

### String Storage

Store GUIDs as CHAR(36) or VARCHAR(36):

```php
// Migration
Schema::create('users', function (Blueprint $table) {
    $table->char('id', 36)->primary();
    // or
    $table->uuid('id')->primary(); // Laravel's uuid() method
});
```

### Binary Storage (More Efficient)

Convert GUIDs to binary for storage efficiency:

```php
use Ramsey\Uuid\Uuid;

// Convert to binary (16 bytes)
$binary = Uuid::fromString($userId->toString())->getBytes();

// Store in database
DB::table('users')->insert([
    'id' => $binary,
]);

// Retrieve from database
$binary = DB::table('users')->value('id');
$uuid = Uuid::fromBytes($binary);
$userId = UserId::fromString(mb_strtoupper($uuid->toString()));
```

Binary storage saves 20 bytes per record (36 chars vs 16 bytes).

### Database Collation

For case-insensitive GUID storage and comparison:

```php
// MySQL migration with case-insensitive collation
Schema::create('users', function (Blueprint $table) {
    $table->char('id', 36)
        ->collation('utf8mb4_unicode_ci') // Case-insensitive
        ->primary();
});
```

## Performance Characteristics

### Generation Speed
- Identical to UUID v4 (same underlying implementation)
- Only difference: uppercase conversion overhead (negligible)

### Database Indexing
- Random distribution (no sequential ordering)
- May cause B-tree index fragmentation
- Consider UUID v7 or ULID for time-ordered needs

### Uniqueness Guarantees
- 122 bits of randomness
- Collision probability: ~2.7×10⁻¹⁸ for 1 billion IDs
- Effectively zero probability in practice

## Use Cases

**When to Choose GUID:**

1. **Microsoft Integration**
   - Interfacing with .NET applications
   - SQL Server databases
   - Azure services
   - Windows-based systems

2. **Legacy Compatibility**
   - Existing systems using uppercase UUIDs
   - Microsoft-originated data formats
   - COM/ActiveX component integration

3. **API Contracts**
   - APIs requiring uppercase UUID format
   - Microsoft Graph API integration
   - Office 365 / SharePoint integration

4. **Cross-Platform Consistency**
   - Mixed .NET/PHP environments
   - Microservices with .NET and PHP components
   - Shared identifier format across technology stacks

**When to Choose UUID Instead:**

1. **Web Standards**
   - Most web APIs expect lowercase UUIDs
   - RESTful API best practices
   - JSON API specifications

2. **Unix/Linux Environments**
   - Non-Microsoft technology stacks
   - Cloud-native applications (AWS, GCP)
   - Container-based systems

3. **Existing Lowercase Systems**
   - Migrating from UUID v4
   - Consistency with existing data
   - Third-party integrations expecting lowercase

## Braces Notation

Microsoft tools sometimes use GUIDs with braces:

```
{550E8400-E29B-41D4-A716-446655440000}
```

The `GuidGenerator` produces GUIDs **without** braces by default. Add braces manually if needed:

```php
$userId = UserId::generate();
$guidWithBraces = '{' . $userId->toString() . '}';
// Result: "{550E8400-E29B-41D4-A716-446655440000}"
```

Or create a custom wrapper:

```php
final readonly class BracedUserId
{
    public function __construct(private UserId $userId) {}

    public function toString(): string
    {
        return '{' . $this->userId->toString() . '}';
    }

    public static function generate(): self
    {
        return new self(UserId::generate());
    }
}

$userId = BracedUserId::generate();
echo $userId->toString(); // "{550E8400-E29B-41D4-A716-446655440000}"
```

## Migration Between GUID and UUID

If migrating between GUID and UUID formats:

### From UUID to GUID

```php
// Convert existing lowercase UUID to GUID
use function mb_strtoupper;

$existingUuid = '550e8400-e29b-41d4-a716-446655440000';
$guid = mb_strtoupper($existingUuid);
// Result: "550E8400-E29B-41D4-A716-446655440000"

$userId = UserId::fromString($guid);
```

### From GUID to UUID

```php
// Convert existing uppercase GUID to UUID
use function mb_strtolower;

$existingGuid = '550E8400-E29B-41D4-A716-446655440000';
$uuid = mb_strtolower($existingGuid);
// Result: "550e8400-e29b-41d4-a716-446655440000"

$userId = UserId::fromString($uuid);
```

### Database Migration

Update existing records from one format to another:

```php
// Convert all UUIDs to GUIDs
DB::table('users')->lazyById()->each(function ($user) {
    DB::table('users')
        ->where('id', $user->id)
        ->update(['id' => mb_strtoupper($user->id)]);
});
```

**Note:** This is only necessary if case-sensitive storage/comparison is required. Most databases handle GUIDs/UUIDs case-insensitively by default.

## Testing with GUIDs

### Mocking GUID Generation

For deterministic testing:

```php
use Cline\StronglyTypedId\Facades\IdGenerator;
use Cline\StronglyTypedId\Generators\GuidGenerator;

// In tests
$mockGenerator = new class implements IdGeneratorInterface {
    public function generate(): string {
        return '550E8400-E29B-41D4-A716-446655440000';
    }
};

IdGenerator::swap($mockGenerator);

$userId = UserId::generate();
expect($userId->toString())->toBe('550E8400-E29B-41D4-A716-446655440000');
```

### Factories with GUIDs

In Laravel factories:

```php
use Illuminate\Database\Eloquent\Factories\Factory;

class UserFactory extends Factory
{
    public function definition(): array
    {
        return [
            'id' => UserId::generate()->toString(),
            'name' => fake()->name(),
        ];
    }
}
```

### Assertions

Testing GUID format:

```php
use function mb_strtoupper;

test('generates valid GUID', function () {
    $userId = UserId::generate();
    $guid = $userId->toString();

    // Check length
    expect($guid)->toHaveLength(36);

    // Check uppercase
    expect($guid)->toBe(mb_strtoupper($guid));

    // Check format pattern
    expect($guid)->toMatch('/^[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}$/');
});
```

## Best Practices

1. **Use GUID for Microsoft Integration**: When interfacing with .NET, SQL Server, or Azure
2. **Normalize for Comparison**: Always normalize case when comparing GUIDs from different sources
3. **Store Consistently**: Choose one format (uppercase/lowercase) for database storage
4. **Document Format Choice**: Clearly document whether your API returns GUID or UUID format
5. **Consider Collation**: Use case-insensitive collation for GUID columns if case doesn't matter
6. **Avoid Braces Unless Required**: Only add braces when interfacing with systems that require them

## Further Reading

- [Microsoft GUID Documentation](https://learn.microsoft.com/en-us/dotnet/api/system.guid)
- [RFC 4122 - UUID Specification](https://datatracker.ietf.org/doc/html/rfc4122)
- [UUID vs GUID](https://en.wikipedia.org/wiki/Universally_unique_identifier)
